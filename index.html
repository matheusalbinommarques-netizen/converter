<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Universal Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
      body { font-family: 'Inter', sans-serif; }
      
      /* Scrollbar Customizada */
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
      ::-webkit-scrollbar-thumb:hover { background: #475569; }

      /* Dropzone Efeitos */
      .drop-zone {
        background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23334155FF' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        transition: all 0.3s ease;
      }
      .drop-zone:hover {
        background-color: rgba(30, 41, 59, 0.8);
        background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%2322D3EEFF' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        transform: translateY(-2px);
        box-shadow: 0 10px 30px -10px rgba(34, 211, 238, 0.15);
        cursor: pointer;
      }
      .drop-zone.drag-over {
        background-color: rgba(6, 182, 212, 0.1);
        transform: scale(0.98);
      }

      /* Animação Status */
      @keyframes pulse-ring {
        0% { transform: scale(0.8); opacity: 0.5; }
        100% { transform: scale(2); opacity: 0; }
      }
      .status-running-dot::before {
        content: ''; position: absolute; width: 100%; height: 100%;
        background-color: inherit; border-radius: 50%;
        animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
      }
    </style>
  </head>

  <body class="min-h-screen bg-[#0B0F19] text-slate-200 antialiased flex items-center justify-center py-8 px-4">
    
    <div class="w-full max-w-5xl bg-slate-900/40 backdrop-blur-2xl border border-white/5 rounded-[2rem] shadow-2xl p-8 relative">
      
      <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[500px] h-[200px] bg-cyan-500/10 blur-[100px] rounded-full pointer-events-none"></div>

      <header class="relative flex flex-col items-center justify-center text-center space-y-3 mb-10">
          <div class="flex items-center justify-center p-3 bg-slate-800/50 rounded-2xl border border-white/5 shadow-lg mb-2">
            <img src="./logo/Universal_Converter.svg" alt="UC" class="h-10 w-10 rounded-lg" onerror="this.style.display='none'">
          </div>
          <h1 class="text-3xl font-bold tracking-tight text-white bg-clip-text text-transparent bg-gradient-to-r from-white via-slate-200 to-slate-400">
            Universal Converter
          </h1>
          <p class="text-sm text-slate-400">Suíte de conversão multimídia</p>
      </header>

      <main class="grid grid-cols-1 lg:grid-cols-2 gap-8 relative z-10">
        
        <section class="space-y-6 flex flex-col">
          
          <div class="space-y-4">
            <div class="relative group z-50">
              <label class="block text-xs font-semibold text-cyan-400 mb-1.5 uppercase tracking-wider ml-1">Converter para</label>
              <div class="relative">
                <select id="conversion-kind" class="w-full bg-slate-800/90 text-white text-sm border border-slate-700 rounded-xl px-4 py-3 outline-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500/50 transition-all appearance-none cursor-pointer hover:bg-slate-800 shadow-xl">
                    <option value="image">Imagem (WebP/PNG/JPG)</option>
                    <option value="video-mp3">Vídeo (MP4) → Áudio (MP3)</option>
                    <option value="video-gif">Vídeo (MP4) → GIF Animado</option>
                    <option value="spritesheet">Múltiplas Imagens → Spritesheet</option>
                    <option value="video-spritesheet">Vídeo (MP4) → Spritesheet</option>
                    <option value="spritesheet-video">Spritesheet → Vídeo</option>
                    <option value="image-pdf">Imagens → PDF</option>
                    <option value="pdf-image">PDF → Imagens</option>
                </select>
                <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                  <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </div>
              </div>
            </div>

            <div class="relative group z-40">
               <div class="flex justify-between items-end mb-1.5 ml-1">
                 <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider">Preset</label>
                 <div id="preset-hint" class="text-[10px] text-cyan-500/80 font-medium"></div>
               </div>
               <div class="relative">
                 <select id="preset-select" class="w-full bg-slate-900/40 text-slate-300 text-xs border border-slate-800 rounded-lg px-3 py-2 outline-none focus:border-cyan-500/50 transition-all appearance-none cursor-pointer hover:bg-slate-900/60"></select>
                 <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500">
                   <svg width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                 </div>
               </div>
            </div>
          </div>

          <div class="p-5 rounded-2xl bg-slate-950/30 border border-white/5 shadow-inner z-0">
             
             <div id="options-image" class="space-y-3">
                <div class="space-y-1">
                   <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Formato Saída</label>
                   <select id="image-format" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-white focus:border-cyan-500 outline-none">
                     <option value="webp">WebP</option>
                     <option value="png">PNG</option>
                     <option value="jpg">JPG</option>
                   </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div class="space-y-1">
                    <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Largura (px)</label>
                    <input id="image-width" type="number" placeholder="Original" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-white focus:border-cyan-500 outline-none placeholder-slate-600">
                  </div>
                  <div class="space-y-1">
                    <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Qualidade</label>
                    <input id="image-quality" type="number" value="80" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-white focus:border-cyan-500 outline-none">
                  </div>
                </div>
             </div>

             <div id="options-video-gif" class="hidden space-y-3">
                <div class="grid grid-cols-2 gap-4">
                  <div class="space-y-1">
                    <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Largura (px)</label>
                    <input id="gif-width" type="number" placeholder="480" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-white focus:border-cyan-500 outline-none">
                  </div>
                  <div class="space-y-1">
                    <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">FPS</label>
                    <input id="gif-fps" type="number" value="12" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-white focus:border-cyan-500 outline-none">
                  </div>
                </div>
             </div>

             <div id="options-spritesheet" class="hidden space-y-3">
                <div class="grid grid-cols-2 gap-4">
                  <div class="space-y-1">
                    <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Colunas</label>
                    <input id="sheet-columns" type="number" placeholder="Auto" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-white focus:border-cyan-500 outline-none">
                  </div>
                  <div class="space-y-1">
                    <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Nome</label>
                    <input id="sheet-name" type="text" placeholder="spritesheet" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-white focus:border-cyan-500 outline-none">
                  </div>
                </div>
             </div>

             <div id="options-video-spritesheet" class="hidden space-y-3">
                <div class="grid grid-cols-2 gap-4">
                   <div class="space-y-1">
                     <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Largura</label>
                     <input id="vs-width" type="number" placeholder="480" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-white focus:border-cyan-500 outline-none">
                   </div>
                   <div class="space-y-1">
                     <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Frames</label>
                     <input id="vs-frames" type="number" placeholder="16" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-white focus:border-cyan-500 outline-none">
                   </div>
                </div>
                <div class="space-y-1">
                   <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Colunas</label>
                   <input id="vs-columns" type="number" placeholder="Auto" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-white focus:border-cyan-500 outline-none">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Nome</label>
                    <input id="vs-name" type="text" placeholder="video_sheet" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-white focus:border-cyan-500 outline-none">
                 </div>
             </div>

             <div id="options-spritesheet-video" class="hidden space-y-3">
                <div class="space-y-1">
                  <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">FPS</label>
                  <input id="sv-fps" type="number" value="12" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-white focus:border-cyan-500 outline-none">
                </div>
             </div>
          </div>

          <div id="drop-zone" class="drop-zone group relative flex flex-col items-center justify-center h-36 rounded-2xl cursor-pointer">
              <div class="p-3 bg-slate-800/50 rounded-full mb-2 group-hover:bg-cyan-500/20 group-hover:text-cyan-400 transition-colors">
                 <svg class="w-6 h-6 text-slate-400 group-hover:text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                 </svg>
              </div>
              <p id="drop-text-primary" class="text-sm font-medium text-slate-300 group-hover:text-white transition-colors">Clique ou arraste arquivos</p>
              <p id="drop-text-secondary" class="text-[10px] text-slate-500 mt-1">Suporta imagens, vídeos e PDF</p>
          </div>

          <button id="convert-btn" disabled class="w-full relative group overflow-hidden rounded-xl bg-gradient-to-r from-cyan-600 to-blue-600 p-px shadow-lg shadow-cyan-900/20 transition-all hover:shadow-cyan-500/40 disabled:opacity-50 disabled:shadow-none disabled:cursor-not-allowed">
            <div class="relative rounded-[10px] bg-slate-900/50 group-hover:bg-transparent transition-colors h-full px-4 py-3.5">
               <span class="relative flex items-center justify-center gap-2 text-sm font-bold text-white tracking-wide">
                 <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                 INICIAR CONVERSÃO
               </span>
            </div>
          </button>
          
          <div id="status-bar" class="text-center text-xs font-medium text-slate-500 min-h-[1rem]"></div>
        </section>

        <section class="flex flex-col bg-slate-950/40 border border-slate-800/50 rounded-2xl p-5 h-[580px] shadow-inner backdrop-blur-md">
          
          <div class="flex items-center justify-between mb-5 pb-3 border-b border-white/5">
            <div class="flex items-center gap-2">
              <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Fila de Processamento</span>
              <span id="queue-count" class="bg-slate-800 text-slate-300 text-[10px] px-2 py-0.5 rounded-full">0</span>
            </div>
            <button id="clear-tasks-btn" title="Limpar Fila" class="text-slate-500 hover:text-red-400 transition-colors p-1 rounded-md hover:bg-slate-800/50">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            </button>
          </div>

          <div id="task-list" class="flex-1 overflow-y-auto space-y-2 pr-1 hidden custom-scrollbar"></div>

          <div id="empty-queue-state" class="flex flex-col items-center justify-center h-full text-slate-600/50">
             <svg class="w-16 h-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
             </svg>
             <span class="text-sm font-medium text-slate-500">A fila está vazia</span>
             <span class="text-[10px] text-slate-600 mt-1">Adicione arquivos para começar</span>
          </div>
        </section>
      </main>
    </div>

    <script>
      const kindSelect = document.getElementById('conversion-kind');
      const presetSelect = document.getElementById('preset-select');
      const presetHintEl = document.getElementById('preset-hint');
      const dropZone = document.getElementById('drop-zone');
      const convertBtn = document.getElementById('convert-btn');
      const clearTasksBtn = document.getElementById('clear-tasks-btn');
      const statusBar = document.getElementById('status-bar');
      const taskListEl = document.getElementById('task-list');
      const emptyStateEl = document.getElementById('empty-queue-state');
      const queueCountEl = document.getElementById('queue-count');

      const optionContainers = [
        document.getElementById('options-image'),
        document.getElementById('options-video-gif'),
        document.getElementById('options-spritesheet'),
        document.getElementById('options-video-spritesheet'),
        document.getElementById('options-spritesheet-video')
      ];

      let selectedFilePaths = [];
      let tasks = [];

      // --- 1. CONFIGURAÇÃO DE PRESETS COM NOVOS FRAMES ---
      const PRESETS = {
        image: [
          { id: 'webp-80', name: 'WebP (Otimizado)', options: { targetFormat: 'webp', quality: 80 } },
          { id: 'jpg-hd', name: 'JPEG (Alta Qualidade)', options: { targetFormat: 'jpg', quality: 90 } },
          { id: 'png', name: 'PNG (Transparente)', options: { targetFormat: 'png', quality: 100 } }
        ],
        'video-gif': [
          { id: 'gif-meme', name: 'Meme (480px / 12fps)', options: { width: 480, fps: 12 } },
          { id: 'gif-hd', name: 'HD (720px / 15fps)', options: { width: 720, fps: 15 } }
        ],
        'video-spritesheet': [
            { id: 'vs-16', name: '16 Frames', options: { frameCount: 16 } },
            { id: 'vs-32', name: '32 Frames', options: { frameCount: 32 } },
            { id: 'vs-64', name: '64 Frames', options: { frameCount: 64 } },
            { id: 'vs-128', name: '128 Frames', options: { frameCount: 128 } },
            { id: 'vs-256', name: '256 Frames', options: { frameCount: 256 } },
            { id: 'vs-512', name: '512 Frames', options: { frameCount: 512 } },
            { id: 'vs-1024', name: '1024 Frames', options: { frameCount: 1024 } },
            { id: 'vs-2048', name: '2048 Frames', options: { frameCount: 2048 } }
        ],
        spritesheet: [
          { id: 'sheet-8', name: '8 Colunas', options: { columns: 8 } }
        ]
      };

      // --- 2. FUNÇÕES AUXILIARES ---

      function updateOptionsVisibility() {
        const kind = kindSelect.value;
        optionContainers.forEach(el => el.classList.add('hidden'));
        
        if (kind === 'image') document.getElementById('options-image').classList.remove('hidden');
        else if (kind === 'video-gif') document.getElementById('options-video-gif').classList.remove('hidden');
        else if (kind === 'spritesheet') document.getElementById('options-spritesheet').classList.remove('hidden');
        else if (kind === 'video-spritesheet') document.getElementById('options-video-spritesheet').classList.remove('hidden');
        else if (kind === 'spritesheet-video') document.getElementById('options-spritesheet-video').classList.remove('hidden');
      }

      function refreshPresetSelect() {
        const kind = kindSelect.value;
        const presets = PRESETS[kind] || [];
        const custom = { id: 'custom', name: 'Personalizado', options: null };
        const list = [custom, ...presets];

        presetSelect.innerHTML = '';
        list.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name;
          presetSelect.appendChild(opt);
        });
        presetSelect.value = 'custom';
        presetHintEl.textContent = '';
      }

      function applyOptionsForKind(kind, preset) {
        if (!preset || typeof preset !== 'object') return;
        
        if (kind === 'video-spritesheet') {
            if (preset.frameCount) document.getElementById('vs-frames').value = preset.frameCount;
        }
        if (kind === 'image') {
           if(preset.targetFormat) document.getElementById('image-format').value = preset.targetFormat;
           if(preset.quality) document.getElementById('image-quality').value = preset.quality;
        }
      }

      function updateSelectionUI() {
        const p1 = document.getElementById('drop-text-primary');
        const p2 = document.getElementById('drop-text-secondary');

        if (selectedFilePaths.length === 0) {
           p1.textContent = 'Clique ou arraste arquivos';
           p1.className = 'text-sm font-medium text-slate-300 group-hover:text-white transition-colors';
           p2.textContent = 'Suporta imagens, vídeos e PDF';
           p2.className = 'text-[10px] text-slate-500 mt-1';
           dropZone.style.borderColor = ''; 
           convertBtn.disabled = true;
        } else {
           const s = selectedFilePaths.length > 1 ? 's' : '';
           p1.textContent = `${selectedFilePaths.length} arquivo${s} selecionado${s}`;
           p1.className = 'text-sm font-bold text-cyan-400 transition-colors';
           p2.textContent = 'Pronto para converter';
           p2.className = 'text-[10px] text-cyan-500/70 mt-1';
           dropZone.style.borderColor = '#22d3ee';
           convertBtn.disabled = false;
        }
      }

      function renderTasks() {
        queueCountEl.textContent = tasks.length;

        if (tasks.length === 0) {
          taskListEl.classList.add('hidden');
          emptyStateEl.classList.remove('hidden');
          emptyStateEl.classList.add('flex');
          return;
        }

        taskListEl.classList.remove('hidden');
        emptyStateEl.classList.add('hidden');
        emptyStateEl.classList.remove('flex');
        
        taskListEl.innerHTML = '';

        tasks.forEach(task => {
          const row = document.createElement('div');
          row.className = 'flex items-center gap-3 p-3 bg-slate-900/50 rounded-lg border border-slate-800 hover:border-slate-700 transition-colors group';
          
          const status = task.status || 'pending';
          let statusColor = 'bg-slate-600';
          let statusDotClass = '';
          
          if(status === 'running') { statusColor = 'bg-amber-400'; statusDotClass = 'status-running-dot relative'; }
          if(status === 'completed') statusColor = 'bg-emerald-400 shadow-[0_0_8px_rgba(52,211,153,0.5)]';
          if(status === 'failed') statusColor = 'bg-red-400';

          const fileName = task.inputPaths && task.inputPaths[0] ? task.inputPaths[0].split(/[/\\]/).pop() : 'Arquivo';

          row.innerHTML = `
             <div class="w-2.5 h-2.5 rounded-full ${statusColor} ${statusDotClass} flex-shrink-0"></div>
             <div class="flex-1 min-w-0">
                <div class="text-xs font-medium text-slate-200 truncate" title="${fileName}">${fileName}</div>
                <div class="text-[10px] text-slate-500 truncate">${task.kind}</div>
             </div>
          `;

          if(status === 'completed' && task.resultPaths && task.resultPaths[0]) {
             const btn = document.createElement('button');
             btn.className = 'text-[10px] bg-slate-800 hover:bg-cyan-600 text-slate-300 hover:text-white px-2 py-1 rounded transition opacity-0 group-hover:opacity-100';
             btn.textContent = 'Abrir';
             btn.onclick = () => window.api?.openInFolder(task.resultPaths[0]);
             row.appendChild(btn);
          }

          taskListEl.appendChild(row);
        });
      }

      // --- 3. LÓGICA PRINCIPAL & CORREÇÃO DE DUPLICIDADE ---

      // Função segura para adicionar/atualizar tarefas sem duplicar visualmente
      function mergeTasks(newTasksList) {
        newTasksList.forEach(nt => {
            const idx = tasks.findIndex(t => t.id === nt.id);
            if (idx > -1) {
                // Se já existe, atualiza
                tasks[idx] = nt;
            } else {
                // Se não existe, adiciona
                tasks.push(nt);
            }
        });
        renderTasks();
      }

      dropZone.addEventListener('click', async () => {
         if(!window.api?.chooseFiles) {
            console.warn('API não encontrada (Modo Browser?)');
            return;
         }
         
         statusBar.textContent = 'Selecionando...';
         try {
           const paths = await window.api.chooseFiles(kindSelect.value);
           if(paths && paths.length) {
              paths.forEach(p => { if(!selectedFilePaths.includes(p)) selectedFilePaths.push(p); });
              updateSelectionUI();
              statusBar.textContent = '';
           }
         } catch(e) { console.error(e); statusBar.textContent = ''; }
      });

      // Drag & Drop
      ['dragenter', 'dragover'].forEach(evt => {
         dropZone.addEventListener(evt, (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
      });
      ['dragleave', 'drop'].forEach(evt => {
         dropZone.addEventListener(evt, (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); });
      });
      dropZone.addEventListener('drop', (e) => {
         if(e.dataTransfer && e.dataTransfer.files.length) {
            const paths = [];
            for(const f of e.dataTransfer.files) if(f.path) paths.push(f.path);
            if(paths.length) {
               paths.forEach(p => { if(!selectedFilePaths.includes(p)) selectedFilePaths.push(p); });
               updateSelectionUI();
            }
         }
      });

      // Botão Converter
      convertBtn.addEventListener('click', async () => {
         if(!selectedFilePaths.length) return;
         if(!window.api?.enqueueTasks) {
            alert('Erro: API backend desconectada.');
            return;
         }

         // Coletar opções atuais
         const currentPresetId = presetSelect.value;
         const currentPreset = PRESETS[kindSelect.value]?.find(p => p.id === currentPresetId);
         const options = currentPreset ? currentPreset.options : {}; 

         try {
            const newTasks = await window.api.enqueueTasks({
               kind: kindSelect.value,
               filePaths: [...selectedFilePaths],
               options: options
            });
            selectedFilePaths = [];
            updateSelectionUI();
            
            // CORREÇÃO DUPLICIDADE: Usamos mergeTasks em vez de push direto
            mergeTasks(newTasks);
            statusBar.textContent = 'Processando na fila...';
         } catch(e) {
            statusBar.textContent = 'Erro ao iniciar: ' + e.message;
            statusBar.className = 'text-center text-xs font-medium text-red-400 min-h-[1rem]';
         }
      });

      clearTasksBtn.addEventListener('click', () => {
         tasks = [];
         renderTasks();
         statusBar.textContent = 'Fila limpa.';
      });

      kindSelect.addEventListener('change', () => {
         updateOptionsVisibility();
         refreshPresetSelect();
         if(window.api?.getLastPreset) {
            window.api.getLastPreset(kindSelect.value)
              .then(p => applyOptionsForKind(kindSelect.value, p))
              .catch(() => {});
         }
      });
      
      presetSelect.addEventListener('change', () => {
         const kind = kindSelect.value;
         const presets = PRESETS[kind] || [];
         const sel = presets.find(p => p.id === presetSelect.value);
         if(sel) applyOptionsForKind(kind, sel.options);
      });

      // Init
      updateOptionsVisibility(); 
      refreshPresetSelect();

      // Listener de eventos do backend (Protegido contra duplicidade)
      if(window.api?.onQueueEvent) {
         window.api.onQueueEvent((data) => {
            if(data.task) {
               mergeTasks([data.task]); // Usa a mesma função de merge para evitar duplicatas
            }
         });
      }

      if(window.api?.getLastPreset) {
          window.api.getLastPreset(kindSelect.value)
            .then(p => applyOptionsForKind(kindSelect.value, p))
            .catch(() => {});
      }

    </script>
  </body>
</html>